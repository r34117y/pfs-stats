{% extends 'base.html.twig' %}

{% block body %}
    <div x-data="rankingData()" x-init="fetchRanking()"
         style="display: flex; justify-content: center; margin-top: 64px;">
        <template x-if="loading">
            <p>Ładowanie...</p>
        </template>
        <div  x-show="!loading">
            <div class="control mb-5">
                <input class="input" type="search" placeholder="Filtruj" @input="setSearch($event.target.value)">
            </div>
            {% include 'static/_partials/_pagination.html.twig' %}
            <table class="table is-bordered is-hoverable">
                <thead>
                <tr>
                    <th @click="sort('position')">Pozycja</th>
                    <th @click="sort('nameAlph')">Zawodnik</th>
                    <th @click="sort('rank')">Ranking</th>
                    <th @click="sort('numberOfGames')">Gier</th>
                    <th @click="sort('rankDelta')">Wzrost</th>
                    <th @click="sort('positionDelta')">Miejsce</th>
                    <th>Statystyki</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="row in pagedRanking" :key="row.position">
                    <tr>
                        <td x-text="row.position + '.'"></td>
                        <td class="text-center" x-text="row.nameShow"></td>
                        <td class="text-center" x-text="row.rank"></td>
                        <td class="text-center" x-text="row.numberOfGames"></td>
                        <td class="text-center" x-text="row.rankDelta"></td>
                        <td class="text-center" x-text="row.positionDelta"></td>
                        <td class="text-center">
                            <a :href="`/players/${row.playerId}`">Statystyki</a>
                        </td>
                    </tr>
                </template>
                </tbody>
            </table>
            {% include 'static/_partials/_pagination.html.twig' %}
        </div>
    </div>
    <script>
        function rankingData() {
            return {
                search: '',
                sortCol: 'position',
                sortAsc: true,
                pageSize: 50,
                curPage: 1,
                ranking: [],
                loading: true,
                async fetchRanking() {
                    try {
                        let response = await fetch('/api/ranking');
                        if (!response.ok) {
                            throw new Error('Błąd ładowania danych');
                        }
                        let data = await response.json();
                        this.ranking = data.rows;
                    } catch (error) {
                        console.error('Błąd:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                sort(col) {
                    if (this.sortCol === col) this.sortAsc = !this.sortAsc;
                    this.sortCol = col;
                    this.ranking.sort((a, b) => {
                        if (a[this.sortCol] < b[this.sortCol]) return this.sortAsc ? 1 : -1;
                        if (a[this.sortCol] > b[this.sortCol]) return this.sortAsc ? -1 : 1;
                        return 0;
                    });
                },
                nextPage() {
                    if((this.curPage * this.pageSize) < this.ranking.length) {
                        this.curPage++;
                    }
                },
                previousPage() {
                    if(this.curPage > 1) {
                        this.curPage--;
                    }
                },
                setSearch (search) {
                    this.curPage = 1;
                    this.search = search;
                },
                get filteredRanking() {
                    if (this.search === '') {
                        return this.ranking;
                    }
                    return this.ranking.filter((row, index) => {
                        return row.nameShow.toLowerCase().includes(this.search.toLowerCase());
                    })
                },
                get pagedRanking() {
                    if(this.ranking) {
                        const start = (this.curPage-1) * this.pageSize;
                        const end = this.curPage * this.pageSize;
                        return this.filteredRanking.filter((row, index) => {
                            return index >= start && index < end
                        })
                    } else {
                        return [];
                    }
                }
            };
        }
    </script>
{% endblock %}

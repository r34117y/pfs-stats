{% extends 'base.html.twig' %}

{% block body %}
    <div x-data="rankingData()" x-init="fetchRanking()"
         style="display: flex; justify-content: center; margin-top: 64px;">
        <template x-if="loading">
            <p>Ładowanie...</p>
        </template>
        <div  x-show="!loading">
            <div class="control mb-5">
                <input class="input" type="search" placeholder="Filtruj" @input="setSearch($event.target.value)">
            </div>
            {% include 'static/_partials/_pagination.html.twig' %}
            <table class="table is-bordered is-hoverable">
                <thead>
                <tr>
                    <th class="text-center" @click="sort('position')">#</th>
                    <th @click="sort('nameAlph')">Zawodnik</th>
                    <th class="text-center" @click="sort('rank')">Ranking</th>
                    <th class="text-center" @click="sort('numberOfGames')">Gier</th>
                    <th class="text-center" @click="sort('rankDelta')">Wzrost</th>
                    <th class="text-center" @click="sort('positionDelta')">Miejsce</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="row in pagedRanking" :key="row.position">
                    <tr>
                        <td class="text-center" x-text="row.position + '.'"></td>
                        <td>
                            <div class="is-flex is-align-items-center" style="gap: 0.5rem;">
                                <template x-if="row.photo">
                                    <figure class="image is-32x32">
                                        <img
                                            x-bind:src="row.photo"
                                            alt="Zdjecie zawodnika"
                                            style="border-radius: 9999px; object-fit: cover; border: 1px solid #dbdbdb;"
                                        >
                                    </figure>
                                </template>
                                <template x-if="!row.photo">
                                    <div
                                        class="is-flex is-justify-content-center is-align-items-center"
                                        style="width: 32px; height: 32px; border-radius: 9999px; border: 1px solid #dbdbdb; background: #f5f5f5;"
                                        aria-label="Brak zdjecia"
                                    >
                                        <svg viewBox="0 0 24 24" width="18" height="18" fill="#7a7a7a" aria-hidden="true">
                                            <path d="M12 12c2.76 0 5-2.47 5-5.5S14.76 1 12 1 7 3.47 7 6.5 9.24 12 12 12Zm0 2c-4.42 0-8 2.91-8 6.5V23h16v-2.5c0-3.59-3.58-6.5-8-6.5Z"></path>
                                        </svg>
                                    </div>
                                </template>
                                <a :href="`/players/${row.playerId}`" x-text="row.nameShow"></a>
                            </div>
                        </td>
                        <td class="text-center" x-text="row.rank"></td>
                        <td class="text-center" x-text="row.numberOfGames"></td>
                        <td class="text-center" x-text="formatSigned(row.rankDelta, 2)"></td>
                        <td class="text-center" x-text="formatSigned(row.positionDelta)"></td>
                    </tr>
                </template>
                </tbody>
            </table>
            {% include 'static/_partials/_pagination.html.twig' %}
        </div>
    </div>
    <script>
        function rankingData() {
            return {
                search: '',
                sortCol: 'position',
                sortAsc: true,
                pageSize: 50,
                curPage: 1,
                ranking: [],
                loading: true,
                async fetchRanking() {
                    try {
                        let response = await fetch('/api/ranking');
                        if (!response.ok) {
                            throw new Error('Błąd ładowania danych');
                        }
                        let data = await response.json();
                        this.ranking = data.rows;
                    } catch (error) {
                        console.error('Błąd:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                sort(col) {
                    if (this.sortCol === col) this.sortAsc = !this.sortAsc;
                    this.sortCol = col;
                    this.ranking.sort((a, b) => {
                        if (a[this.sortCol] < b[this.sortCol]) return this.sortAsc ? 1 : -1;
                        if (a[this.sortCol] > b[this.sortCol]) return this.sortAsc ? -1 : 1;
                        return 0;
                    });
                },
                formatSigned(value, decimals = null) {
                    if (value === null || value === undefined || value === '') {
                        return '-';
                    }

                    const numericValue = Number(value);
                    if (Number.isNaN(numericValue)) {
                        return '-';
                    }

                    const formatted = decimals === null
                        ? numericValue.toString()
                        : numericValue.toFixed(decimals);

                    if (numericValue > 0) {
                        return `+${formatted}`;
                    }

                    return formatted;
                },
                nextPage() {
                    if((this.curPage * this.pageSize) < this.ranking.length) {
                        this.curPage++;
                    }
                },
                previousPage() {
                    if(this.curPage > 1) {
                        this.curPage--;
                    }
                },
                setSearch (search) {
                    this.curPage = 1;
                    this.search = search;
                },
                get filteredRanking() {
                    if (this.search === '') {
                        return this.ranking;
                    }
                    return this.ranking.filter((row, index) => {
                        return row.nameShow.toLowerCase().includes(this.search.toLowerCase());
                    })
                },
                get pagedRanking() {
                    if(this.ranking) {
                        const start = (this.curPage-1) * this.pageSize;
                        const end = this.curPage * this.pageSize;
                        return this.filteredRanking.filter((row, index) => {
                            return index >= start && index < end
                        })
                    } else {
                        return [];
                    }
                }
            };
        }
    </script>
{% endblock %}

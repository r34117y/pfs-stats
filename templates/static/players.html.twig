{% extends 'base.html.twig' %}

{% block body %}
    <div x-data="playersData()" x-init="fetchPlayers()"
         style="display: flex; justify-content: center; margin-top: 64px;">
        <template x-if="loading">
            <p>Ładowanie...</p>
        </template>
        <div  x-show="!loading">
            <div class="control mb-5">
                <input class="input" type="search" placeholder="Filtruj" @input="setSearch($event.target.value)">
            </div>
            {% include 'static/_partials/_pagination.html.twig' %}
            <table class="table is-bordered is-hoverable">
                <thead>
                <tr>
                    <th @click="sort('nameAlph')">Zawodnik</th>
                    <th @click="sort('ranking')">Ranking</th>
                    <th>Statystyki</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="player in pagedPlayers" :key="player.id">
                    <tr>
                        <td x-text="player.nameShow"></td>
                        <td class="text-center">100</td>
                        <td class="text-center">
                            <a :href="`/players/${player.id}`">Statystyki</a>
                        </td>
                    </tr>
                </template>
                </tbody>
            </table>
            {% include 'static/_partials/_pagination.html.twig' %}
        </div>
    </div>
    <script>
        function playersData() {
            return {
                search: '',
                sortCol: 'nameAlph',
                sortAsc: true,
                pageSize: 50,
                curPage: 1,
                players: [],
                loading: true,
                async fetchPlayers() {
                    try {
                        let response = await fetch('/api/players');
                        if (!response.ok) {
                            throw new Error('Błąd ładowania danych');
                        }
                        let data = await response.json();
                        this.players = data.players;
                    } catch (error) {
                        console.error('Błąd:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                sort(col) {
                    if (this.sortCol === col) this.sortAsc = !this.sortAsc;
                    this.sortCol = col;
                    this.players.sort((a, b) => {
                        if (a[this.sortCol] < b[this.sortCol]) return this.sortAsc ? 1 : -1;
                        if (a[this.sortCol] > b[this.sortCol]) return this.sortAsc ? -1 : 1;
                        return 0;
                    });
                },
                nextPage() {
                    if((this.curPage * this.pageSize) < this.players.length) {
                        this.curPage++;
                    }
                },
                previousPage() {
                    if(this.curPage > 1) {
                        this.curPage--;
                    }
                },
                setSearch (search) {
                    this.curPage = 1;
                    this.search = search;
                },
                get filteredPlayers() {
                    if (this.search === '') {
                        return this.players;
                    }
                    return this.players.filter((row, index) => {
                       return row.nameAlph.toLowerCase().includes(this.search.toLowerCase());
                    })
                },
                get pagedPlayers() {
                    if(this.players) {
                        const start = (this.curPage-1) * this.pageSize;
                        const end = this.curPage * this.pageSize;
                        return this.filteredPlayers.filter((row, index) => {
                            return index >= start && index < end
                        })
                    } else {
                        return [];
                    }
                }
            };
        }
    </script>
{% endblock %}
